{{/* 
影片 Shortcode
用法：
{{< video src="video.mp4" poster="poster.jpg" width="100%" autoplay="true" loop="true" muted="true" controls="true" title="影片標題" caption="影片描述" >}}

參數說明：
- src: 影片來源 (必填) - 可以是本地檔案路徑或 CDN 連結
- poster: 影片封面圖片 (選填)
- width: 影片寬度 (選填，預設 100%)
- height: 影片高度 (選填，預設 auto)
- autoplay: 自動播放 (選填，預設 false)
- loop: 循環播放 (選填，預設 false)
- muted: 靜音 (選填，預設 false)
- controls: 顯示控制項 (選填，預設 true)
- preload: 預載設定 (選填，可選 none/metadata/auto，預設 metadata)
- title: 影片標題 (選填)
- caption: 影片描述/說明文字 (選填)
- class: 自訂 CSS class (選填)
*/}}

{{/* 設定預設值 */}}
{{ $src := .Get "src" }}
{{ $poster := .Get "poster" }}
{{ $width := .Get "width" | default "100%" }}
{{ $height := .Get "height" | default "auto" }}
{{ $autoplay := .Get "autoplay" | default "false" }}
{{ $loop := .Get "loop" | default "false" }}
{{ $muted := .Get "muted" | default "false" }}
{{ $controls := .Get "controls" | default "true" }}
{{ $preload := .Get "preload" | default "metadata" }}
{{ $title := .Get "title" }}
{{ $caption := .Get "caption" }}
{{ $class := .Get "class" | default "video-shortcode" }}

{{/* 檢查必填參數 */}}
{{ if not $src }}
  {{ errorf "video shortcode 缺少必要的 'src' 參數" }}
{{ end }}

{{/* 建立動態樣式字串 */}}
{{ $containerStyle := printf "max-width: %s;" $width }}
{{ $videoStyle := printf "width: %s; height: %s;" $width $height }}

<figure class="video-container {{ $class }}" style="{{ $containerStyle }}">
  
  {{/* 影片標題 */}}
  {{ if $title }}
    <h3 class="video-title">{{ $title | markdownify }}</h3>
  {{ end }}
  
  {{/* 影片元素 */}}
  <video class="video-player"
    style="{{ $videoStyle }}"
    {{ if eq $autoplay "true" }}autoplay{{ end }}
    {{ if eq $loop "true" }}loop{{ end }}
    {{ if eq $muted "true" }}muted{{ end }}
    {{ if eq $controls "true" }}controls{{ end }}
    preload="{{ $preload }}"
    {{ if $poster }}poster="{{ $poster | relURL }}"{{ end }}
    {{ if $title }}aria-label="{{ $title }}"{{ end }}>
    
    {{/* 支援多種影片格式 */}}
    {{ $srcUrl := $src }}
    {{ if not (hasPrefix $src "http") }}
      {{ $srcUrl = $src | relURL }}
    {{ end }}
    
    {{/* 根據檔案副檔名決定 MIME 類型 */}}
    {{ $extension := path.Ext $src | lower }}
    {{ $mimeType := "video/mp4" }}
    {{ if eq $extension ".webm" }}
      {{ $mimeType = "video/webm" }}
    {{ else if eq $extension ".ogg" }}
      {{ $mimeType = "video/ogg" }}
    {{ else if eq $extension ".mov" }}
      {{ $mimeType = "video/quicktime" }}
    {{ else if eq $extension ".avi" }}
      {{ $mimeType = "video/x-msvideo" }}
    {{ end }}
    
    <source src="{{ $srcUrl }}" type="{{ $mimeType }}">
    
    {{/* 備用文字 */}}
    <p>您的瀏覽器不支援影片播放。
      <a href="{{ $srcUrl }}">點此下載影片</a>
    </p>
  </video>
  
  {{/* 影片描述/說明 - 使用 figcaption */}}
  {{ if $caption }}
    <figcaption>{{ $caption | markdownify }}</figcaption>
  {{ end }}
  
</figure>

{{/* 基本樣式 */}}
<style>
.video-container {
  margin: 1.5rem 0;
}

.video-title {
  margin: 0 0 0.5rem 0;
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-primary, #333);
}

.video-player {
  width: 100%;
  height: auto;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.video-caption {
  margin: 0.5rem 0 0 0;
  padding: 0.5rem;
  font-size: 0.9rem;
  color: var(--text-secondary, #666);
  background-color: var(--bg-secondary, #f8f9fa);
  border-radius: 4px;
  border-left: 3px solid var(--accent-color, #007acc);
}

.video-caption p {
  margin: 0;
}

/* 響應式設計 */
@media (max-width: 768px) {
  .video-container {
    margin: 1rem 0;
  }
  
  .video-title {
    font-size: 1.1rem;
  }
  
  .video-caption {
    font-size: 0.85rem;
  }
}
</style>
